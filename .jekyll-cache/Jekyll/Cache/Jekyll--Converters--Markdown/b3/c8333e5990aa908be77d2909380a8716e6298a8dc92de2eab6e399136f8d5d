I"<h1 id="引言">引言</h1>
<p>访问斗鱼首页，会显示当前在线的直播间数量，我想获取这个数据并出图，<br />
这是一个最常见的监控需求。那么如何从外部第三方来实现呢？</p>

<h1 id="思路及实现">思路及实现</h1>

<h2 id="1-首先要获取这个数据">1. 首先要获取这个数据</h2>

<p>一开始，我想到的最直接的方式是，下载首页 HTML，然后提取出数据。（提取方式可以直接用 Shell 或更专业的 Python）<br />
但下载首页后，并没有发现相关的数据。数据并不是写死在 HTML 中的，而是动态载入的。<br />
直接从网页上抓取无法获得数据。<br />
于是我们通过 Chrome 浏览器开发者工具来对其进行分析，可以找到在线直播间数是在这个 API 接口中：<code class="highlighter-rouge">https://www.douyu.com/home/api</code><br />
于是我们就可以通过这个 API 来提取这个数据了。<br />
由于我现在只需要获取这一个数据，使用 Shell 就足够了。（Python 可能在做复杂提取解析时更高效。）</p>

<p>可以马上写出提取在线直播间数的脚本：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@VM_15_187_centos ~]# <span class="nb">cat</span> /usr/local/sbin/get_douyu_live_room.sh 
<span class="c">#!/bin/bash</span>
<span class="nv">ALL_COUNT</span><span class="o">=</span><span class="sb">`</span>/usr/bin/curl <span class="nt">-s</span> https://www.douyu.com/home/api  | egrep <span class="nt">-o</span> <span class="s1">'"all_count":.*,"live_room"'</span> | egrep <span class="nt">-o</span> <span class="s2">"[0-9]*"</span><span class="sb">`</span>

<span class="nb">cat</span> <span class="o">&gt;</span> /usr/share/nginx/html/douyu/live_room.html <span class="o">&lt;&lt;</span>  <span class="no">EOF</span><span class="sh">
&lt;pre&gt;
douyu_online_room:</span><span class="k">${</span><span class="nv">ALL_COUNT</span><span class="k">}</span><span class="sh">
&lt;/pre&gt;
</span><span class="no">EOF

</span></code></pre></div></div>

<p>上面的脚本我们可以看到，将数据写到了 1 个 HTML 中了，这个后面出图时会用到，因为要从这里获取数据。<br />
然后我们使用 crontab 定时获取数据(使用 5 分钟间隔，因为后面的出图监控频率也是 5 分钟)：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@VM_15_187_centos ~]# crontab <span class="nt">-l</span>
<span class="c"># Get Douyu Live Room</span>
<span class="k">*</span>/5 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /bin/sh /usr/local/sbin/get_douyu_live_room.sh
</code></pre></div></div>

<h2 id="2-根据这个数据来出图">2. 根据这个数据来出图</h2>

<p>第一步中，我们获取到了数据，一般情况下，我们需要将这个数据保存到一个位置，然后通过绘图软件读取这个数据并出图。<br />
作为运维，我们常使用的 Zabbix 等可以实现，但是实现方式太重了（依赖数据库）。<br />
我只有这个简单的需求，并不想安装配置重量级的监控软件，先找到了 Munin 这个轻量级的监控软件。<br />
它可以支持自定义监控和出图。它还是需要安装配置。<br />
在这个过程中，我想到，现在是云计算的时代，第三方也有监控服务，比如监控宝，他们应该有类似自定义监控及出图服务。我们应该学会利用。<br />
我的这个获取网页中一个动态数据并出图的小需求是很简单，但却是非常通用的。
在监控宝的网站中，可以找到<a href="http://wiki.jiankongbao.com/doku.php/%E6%96%87%E6%A1%A3:%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7"> 自定义监控功能及配置 </a></p>

<p>根据上面的文档我们就能配置出图了。<br />
下面就是最终的监控图。</p>

<p><img src="http://jaminzhang.github.io/images/Douyu/Douyu-Live-Rooms.png" alt="Douyu-Live-Rooms" /></p>

<h1 id="ref">Ref</h1>
<p><a href="http://www.cnblogs.com/saintlas/p/5740241.html">浅谈如何使用python抓取网页中的动态数据</a></p>

:ET