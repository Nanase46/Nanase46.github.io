I"p<h1 id="salt-state-ç»„ä»¶">Salt State ç»„ä»¶</h1>

<h2 id="ä¸ºä»€ä¹ˆè¦å¼•å…¥-state">ä¸ºä»€ä¹ˆè¦å¼•å…¥ State</h2>

<pre>
Remote execution is a big time saver, but it has some shortcomings. 
Most tasks you perform are a combination of many commands, tests, and operations, 
each with their own nuances and points-of-failure.
Often an attempt is made to combine all of these steps into a central shell script, 
but these quickly get unwieldy and introduce their own headaches.

To solve this, SaltStack configuration management lets you create a re-usable configuration template, 
called a state, that describes everything required to put a system component or application 
into a known configuration.
</pre>

<h2 id="state-ä½¿ç”¨-yaml-æ‰€ä»¥æ˜“è¯»">State ä½¿ç”¨ YAML ï¼Œæ‰€ä»¥æ˜“è¯»</h2>

<p>States are described using YAML, and are simple to create and read.</p>

<p><em>YAML ç®€ä»‹</em></p>

<p>YAML æ˜¯â€YAML Ainâ€™t a Markup Languageâ€ï¼ˆYAMLä¸æ˜¯ä¸€ç§æ ‡è®°è¯­è¨€ï¼‰çš„é€’å½’ç¼©å†™ã€‚å®ƒæ˜¯ç±»ä¼¼äºæ ‡å‡†é€šç”¨æ ‡è®°è¯­è¨€çš„å­é›† XML çš„æ•°æ®æè¿°è¯­è¨€ï¼Œ
è¯­æ³•æ¯” XML ç®€å•å¾ˆå¤šã€‚</p>

<pre>
Salt uses a simple language, called YAML, to describe configurations. This is what you need to know:

YAML uses a fixed indentation scheme to represent relationships between data layers. 
Salt requires that the indentation for each level consists of exactly two spaces. Do not use tabs.

A dash represents an item in a list.

Key value pairs are represented by key: value
</pre>

<p>ä»¥ä¸Šè¯´äº† YAML çš„è¯­æ³•ï¼Œæœ‰ 3 ä¸ªè§„åˆ™ï¼š</p>

<ol>
  <li>ç¼©è¿›ï¼ˆä»£è¡¨æ•°æ®å±‚çº§å…³ç³»ï¼Œ2 ä¸ªç©ºæ ¼ï¼Œå¹¶ä¸”ä¸èƒ½ä½¿ç”¨ TAB é”®ï¼Œæ•´ä¸ª SaltStack é‡Œé¢éƒ½ä¸èƒ½ç”¨ TAB é”®ï¼‰</li>
  <li>å†’å· ï¼š
    <ol>
      <li>è·Ÿç¼©è¿›ä¸€èµ·ä»£è¡¨ä¸€ä¸ªæ•°æ®å±‚çº§ï¼ˆä»¥å†’å·ç»“å°¾ä¸ç”¨ç©ºæ ¼ï¼‰ï¼›</li>
      <li>åˆ†éš”é”®å€¼å¯¹ [key: value] ï¼Œæ”¯æŒåµŒå¥—ï¼Œå†’å·åé¢å¿…é¡»æœ‰ä¸€ä¸ªç©ºæ ¼</li>
    </ol>
  </li>
  <li>çŸ­æ¨ªçº¿ -ï¼ˆè¡¨ç¤ºä¸€ä¸ªåˆ—è¡¨ä¸­çš„ä¸€ä¸ªé¡¹ç›®ï¼Œ- åé¢å¿…é¡»æœ‰ç©ºæ ¼ï¼‰</li>
</ol>

<p>Salt çš„é…ç½®æ–‡ä»¶æ˜¯ YAML è¯­æ³•ã€‚</p>

<h1 id="ç¼–å†™-state-çŠ¶æ€æ–‡ä»¶">ç¼–å†™ STATE çŠ¶æ€æ–‡ä»¶</h1>

<h2 id="1-é…ç½®-master-file_roots">1. é…ç½® Master file_roots</h2>

<p>Salt è¿è¡Œäº†ä¸€ä¸ªä½¿ç”¨ zeromq ç¼–å†™çš„è½»é‡çº§æ–‡ä»¶æœåŠ¡å™¨ï¼Œç”¨äºåˆ†å‘æ–‡ä»¶åˆ° minionsã€‚è¿™ä¸ªæ–‡ä»¶æœåŠ¡å™¨å†…å»ºåˆ° master è¿›ç¨‹ï¼Œå®ƒä¸éœ€è¦ä¸€ä¸ªä¸“ç”¨çš„ç«¯å£ã€‚</p>

<p>è¿™ä¸ªæ–‡ä»¶æœåŠ¡å™¨å·¥ä½œåœ¨ä¼ é€’ç»™ master çš„ç¯å¢ƒä¸Šï¼Œæ¯ä¸ªç¯å¢ƒå¯ä»¥æœ‰å¤šä¸ªæ ¹ç›®å½•ã€‚
ä¸€ä¸ª base ç¯å¢ƒæ˜¯å¿…éœ€çš„ï¼Œé‡Œé¢æ”¾ç½® top file.</p>

<p>ä¾‹å­ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Example:</span>
<span class="c"># file_roots:					# é…ç½®é¡¹</span>
<span class="c">#   base:						# é…ç½® base ç¯å¢ƒ</span>
<span class="c">#     - /srv/salt/				# å¯ä»¥å†™å¤šä¸ªï¼Œæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œbase ç¯å¢ƒçš„æ ¹è·¯å¾„</span>
<span class="c">#   dev:</span>
<span class="c">#     - /srv/salt/dev/services</span>
<span class="c">#     - /srv/salt/dev/states</span>
<span class="c">#   prod:</span>
<span class="c">#     - /srv/salt/prod/services</span>
<span class="c">#     - /srv/salt/prod/states</span>

file_roots:
  base:
    - /srv/salt

<span class="c"># é…ç½®å®Œæˆ master çš„ file_roots åï¼Œè¦é‡å¯ master</span>

systemctl restart salt-master	
	
</code></pre></div></div>

<h2 id="2-ç¼–å†™ä¸€ä¸ª-state-çŠ¶æ€æ–‡ä»¶">2. ç¼–å†™ä¸€ä¸ª STATE çŠ¶æ€æ–‡ä»¶</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># åˆ›å»º base ç¯å¢ƒçš„ç›®å½•</span>
<span class="nb">mkdir</span> /srv/salt <span class="nt">-p</span>
<span class="nb">cd</span> /srv/salt
<span class="nb">mkdir </span>web
<span class="nb">cd </span>web

<span class="c"># ç¼–å†™ä¸€ä¸ªæè¿° apache çŠ¶æ€çš„çŠ¶æ€æ–‡ä»¶</span>
<span class="nb">cat</span> <span class="o">&gt;&gt;</span> apache.sls <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
apache-install:     # çŠ¶æ€å£°æ˜ IDï¼Œæ¯ä¸€ä¸ª ID å°±æ˜¯ä¸€ä¸ªé…ç½®é¡¹
  pkg.installed:    # è¿™é‡Œé¢çš„æ¨¡å—å¯ä»¥æ˜¯å†…ç½®çš„çŠ¶æ€æ¨¡å—ï¼Œä¹Ÿå¯ä»¥æ˜¯è‡ªå®šä¹‰çš„çŠ¶æ€æ¨¡å—
    - names:
        - httpd
        - httpd-devel

apache-service:
  service.running:
    - name: httpd
    - enable: True
</span><span class="no">EOF


</span><span class="c"># ä¸€ä¸ª Salt çŠ¶æ€å¯ä»¥ä½¿ç”¨å•ä¸ªçš„ SLS æ–‡ä»¶ï¼ˆä¸€ä¸ª SLS æ–‡ä»¶å°±å®šä¹‰äº†ä¸€ä¸ªçŠ¶æ€ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨ä¸€ä¸ªç›®å½•ã€‚åè€…æ›´åŠ çµæ´»æ–¹ä¾¿ã€‚</span>

<span class="c"># ä¸Šé¢ä¾‹å­ä¸­ apache-install æ˜¯å®šä¹‰çš„çŠ¶æ€å£°æ˜ IDï¼Œpkg æ˜¯ä¸€ä¸ªçŠ¶æ€æ¨¡å—ï¼Œæ¨¡å—åˆ†ä¸ºæ‰§è¡Œæ¨¡å—å’ŒçŠ¶æ€æ¨¡å—ï¼Œ</span>
installed æ˜¯æ¨¡å—ä¸­å®šä¹‰çš„å‡½æ•°æ–¹æ³•

<span class="c"># Salt æœ‰å¾ˆå¤šçš„æ¨¡å—ï¼Œå®ƒä»¬éƒ½æ”¾åœ¨ /usr/lib/python2.7/site-packages/salt/modules ä¸‹ï¼Œ</span>
è€Œ pkg.py æ˜¯æ”¾åœ¨ /usr/lib/python2.7/site-packages/salt/states ç›®å½•ä¸‹çš„ï¼Œæ‰€ä»¥è¯´å®ƒæ˜¯ä¸€ä¸ªçŠ¶æ€æ¨¡å—
</code></pre></div></div>

<h2 id="3-æ‰§è¡ŒçŠ¶æ€æ¨¡å—">3. æ‰§è¡ŒçŠ¶æ€æ¨¡å—</h2>

<p>salt â€˜*â€™ state.sls web.apache</p>

<blockquote>

  <p>state æ˜¯ä¸€ä¸ªæ¨¡å—ï¼ˆ/usr/lib/python2.7/site-packages/salt/modules/state.pyï¼‰ï¼Œsls æ˜¯å®ƒçš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯ Execute the states in one or more SLS filesï¼Œè¿™äº›çŠ¶æ€æ–‡ä»¶æ˜¯æ”¾åœ¨ç¯å¢ƒä¸‹çš„ï¼Œå¹¶ä¸”è¿™äº›çŠ¶æ€æ–‡ä»¶é‡Œé¢ä¼šè°ƒç”¨ state çš„çŠ¶æ€æ¨¡å—ï¼ˆ/usr/lib/python2.7/site-packages/salt/statesï¼‰ã€‚</p>
</blockquote>

<blockquote>

  <p>/var/cache/salt/minion æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç›®å½•ï¼Œä¸€èˆ¬ master æŠŠæ–‡ä»¶å‘ç»™ minion å¹¶æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹, minionä»ä¸Šå¾€ä¸‹åŠ è½½</p>
</blockquote>

<h2 id="4-é€šè¿‡-topsls-æ¥æœ‰é€‰æ‹©çš„æ‰§è¡ŒçŠ¶æ€æ–‡ä»¶">4. é€šè¿‡ top.sls æ¥æœ‰é€‰æ‹©çš„æ‰§è¡ŒçŠ¶æ€æ–‡ä»¶</h2>

<p>top æ–‡ä»¶ä¹Ÿæ˜¯ sls ç»“å°¾ï¼Œä¹Ÿæ˜¯ YAML æ ¼å¼ã€‚å®ƒæ”¾åœ¨ base ç¯å¢ƒä¸‹ã€‚</p>

<p>```bash</p>
<h1 id="the-state-system-uses-a-top-file-to-tell-the-minions-what-environment-to">The state system uses a â€œtopâ€ file to tell the minions what environment to</h1>
<h1 id="use-and-what-modules-to-use-the-state_top-file-is-defined-relative-to-the">use and what modules to use. The state_top file is defined relative to the</h1>
<h1 id="root-of-the-base-environment-as-defined-in-file-server-settings-below">root of the base environment as defined in â€œFile Server settingsâ€ below.</h1>
<h1 id="state_top-topsls">state_top: top.sls</h1>

<h1 id="top-file-çš„å®è´¨å°±æ˜¯å‘ŠçŸ¥çŠ¶æ€åº”ç”¨åˆ°å“ªäº›-minion-ä¸Šå‘Šè¯‰-minion-ä½¿ç”¨ä»€ä¹ˆç¯å¢ƒå’Œä»€ä¹ˆæ¨¡å—">top file çš„å®è´¨å°±æ˜¯å‘ŠçŸ¥çŠ¶æ€åº”ç”¨åˆ°å“ªäº› minion ä¸Šï¼ˆå‘Šè¯‰ minion ä½¿ç”¨ä»€ä¹ˆç¯å¢ƒå’Œä»€ä¹ˆæ¨¡å—ï¼‰ã€‚</h1>

<p>cat &gt; top.sls Â«EOF
base:
  â€˜linux-node1.example.comâ€™:
    - web.apache
  â€˜linux-node2.example.comâ€™:
    - web.apache
EOF</p>

<h1 id="æ‰§è¡Œé«˜çº§çŠ¶æ€-highstate">æ‰§è¡Œé«˜çº§çŠ¶æ€ highstate</h1>

<p>salt â€˜*â€™ state.highstate</p>

<p>ç”Ÿäº§ä¸­ä¸å»ºè®®ç”¨ * ï¼Œç„¶åè¦å…ˆåœ¨æµ‹è¯•æ¨¡å¼è¿è¡Œï¼Œsalt â€˜*â€™ state.highstate test=True</p>
:ET