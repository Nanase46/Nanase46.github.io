I"Æ&<h1 id="3-æ„å»ºä¼ä¸šçº§åˆ†å¸ƒå¼å­˜å‚¨">3 æ„å»ºä¼ä¸šçº§åˆ†å¸ƒå¼å­˜å‚¨</h1>

<h2 id="31-ç¡¬ä»¶è¦æ±‚">3.1 ç¡¬ä»¶è¦æ±‚</h2>

<p>ä¸€èˆ¬é€‰æ‹© 2U æœºå‹ï¼Œç£ç›˜ SATA ç›˜ 4TBï¼Œå¦‚æœ IO è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¯ä»¥é‡‡è´­ SSD å›ºæ€ç¡¬ç›˜ã€‚<br />
ä¸ºäº†å……åˆ†ä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼Œè¦æ±‚æ‰€æœ‰ glusterfs æœåŠ¡å™¨ç¡¬ä»¶é…ç½®å°½é‡ä¸€è‡´ï¼Œå°¤å…¶æ˜¯ç¡¬ç›˜æ•°é‡å’Œå¤§å°ã€‚<br />
æœºå™¨çš„ RAID å¡éœ€è¦å¸¦ç”µæ± ï¼Œç¼“å­˜è¶Šå¤§ï¼Œæ€§èƒ½è¶Šå¥½ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå»ºè®®åš RAID 10ï¼Œå¦‚æœå‡ºäºç©ºé—´è¦æ±‚çš„è€ƒè™‘ï¼Œéœ€è¦åš RAID 5ï¼Œå»ºè®®æœ€å¥½èƒ½æœ‰ 1-2 å—ç¡¬ç›˜çš„çƒ­å¤‡ç›˜ã€‚</p>

<h2 id="32-ç³»ç»Ÿè¦æ±‚å’Œåˆ†åŒºåˆ’åˆ†">3.2 ç³»ç»Ÿè¦æ±‚å’Œåˆ†åŒºåˆ’åˆ†</h2>

<p>ç³»ç»Ÿå¯ä»¥ä½¿ç”¨ CentOS 6.x x86_64ï¼Œå®‰è£…å®Œæˆåå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå®‰è£…çš„æ—¶å€™ï¼Œä¸è¦ä½¿ç”¨ LVï¼Œ<br />
å»ºè®®ï¼š/boot åˆ†åŒº 200Mï¼Œ/ åˆ†åŒº 100Gï¼Œswap åˆ†åŒºå’Œå†…å­˜ä¸€æ ·å¤§å°ï¼Œå‰©ä½™ç©ºé—´ç»™ gluster ä½¿ç”¨ï¼Œåˆ’åˆ†å•ç‹¬çš„ç¡¬ç›˜ç©ºé—´ã€‚<br />
ç³»ç»Ÿå®‰è£…è½¯ä»¶æ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œå»ºè®®é™¤äº†å¼€å‘å·¥å…·å’ŒåŸºæœ¬çš„ç®¡ç†è½¯ä»¶ï¼Œå…¶ä»–è½¯ä»¶ä¸€å¾‹ä¸å®‰è£…ã€‚</p>

<h2 id="33-ç½‘ç»œç¯å¢ƒ">3.3 ç½‘ç»œç¯å¢ƒ</h2>

<p>ç½‘ç»œè¦æ±‚å…¨éƒ¨åƒå…†ç¯å¢ƒï¼Œgluster æœåŠ¡å™¨è‡³å°‘æœ‰ 2 å—ç½‘å¡ï¼Œ1 å—ç½‘å¡ç»‘å®šä¾› gluster ä½¿ç”¨ï¼Œå‰©ä½™ä¸€å—åˆ†é…ç®¡ç†ç½‘ç»œ IPï¼Œç”¨äºç³»ç»Ÿç®¡ç†ã€‚<br />
å¦‚æœæœ‰æ¡ä»¶è´­ä¹°ä¸‡å…†äº¤æ¢æœºï¼ŒæœåŠ¡å™¨é…ç½®ä¸‡å…†ç½‘å¡ï¼Œå­˜å‚¨æ€§èƒ½ä¼šæ›´å¥½ã€‚ç½‘ç»œæ–¹é¢å¦‚æœå®‰å…¨æ€§è¦æ±‚è¾ƒé«˜ï¼Œå¯ä»¥å¤šç½‘å¡ç»‘å®šã€‚</p>

<blockquote>

  <p>è·¨åœ°åŒºæœºæˆ¿é…ç½® Glusterï¼Œåœ¨ä¸­å›½ç½‘ç»œä¸é€‚ç”¨ã€‚</p>
</blockquote>

<h2 id="34-æœåŠ¡å™¨æ‘†æ”¾åˆ†å¸ƒ">3.4 æœåŠ¡å™¨æ‘†æ”¾åˆ†å¸ƒ</h2>

<p>æœåŠ¡å™¨ä¸»å¤‡æœºå™¨è¦æ”¾åœ¨ä¸åŒçš„æœºæŸœï¼Œè¿æ¥ä¸åŒçš„äº¤æ¢æœºï¼Œå³ä½¿ä¸€ä¸ªæœºæŸœå‡ºç°é—®é¢˜ï¼Œè¿˜æœ‰ä¸€ä»½æ•°æ®æ­£å¸¸è®¿é—®ã€‚</p>

<p><img src="http://jaminzhang.github.io/images/GlusterFS/GlusterFS-Cabinet-01.png" alt="GlusterFS-Cabinet-01" /><br />
<img src="http://jaminzhang.github.io/images/GlusterFS/GlusterFS-Cabinet-02.png" alt="GlusterFS-Cabinet-02" /></p>

<h2 id="35-æ„å»ºé«˜æ€§èƒ½é«˜å¯ç”¨å­˜å‚¨">3.5 æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨å­˜å‚¨</h2>

<p>ä¸€èˆ¬åœ¨ä¼ä¸šä¸­ï¼Œé‡‡ç”¨çš„æ˜¯åˆ†å¸ƒå¼å¤åˆ¶å·ï¼Œå› ä¸ºæœ‰æ•°æ®å¤‡ä»½ï¼Œæ•°æ®ç›¸å¯¹å®‰å…¨ï¼Œåˆ†å¸ƒå¼æ¡å¸¦å·ç›®å‰å¯¹ gluster æ¥è¯´æ²¡æœ‰å®Œå…¨æˆç†Ÿï¼Œå­˜åœ¨ä¸€å®šçš„æ•°æ®å®‰å…¨é£é™©ã€‚</p>

<h3 id="351-å¼€å¯é˜²ç«å¢™ç«¯å£">3.5.1 å¼€å¯é˜²ç«å¢™ç«¯å£</h3>

<p>ä¸€èˆ¬åœ¨ä¼ä¸šåº”ç”¨ä¸­ Linux é˜²ç«å¢™æ˜¯æ‰“å¼€çš„ï¼Œè¿™äº› Gluster æœåŠ¡å™¨ä¹‹é—´è®¿é—®çš„ç«¯å£å¦‚ä¸‹ï¼š</p>

<blockquote>

  <p>iptables -I INPUT -p tcp â€“dport 24007:24011 -j ACCEPT<br />
iptables -I INPUT -p tcp â€“dport 38465:38485 -j ACCEPT</p>
</blockquote>

<p>ä¸Šé¢æ˜¯å·çš„ç«¯å£ï¼Œä¸‹é¢æ˜¯ç¡¬ç›˜çš„ç«¯å£ï¼Œç£ç›˜è¶Šå¤šï¼Œç«¯å£è¶Šå¤š</p>

<h3 id="352-glusterfs-æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–">3.5.2 GlusterFS æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–</h3>

<p><img src="http://jaminzhang.github.io/images/GlusterFS/GlusterFS-Filesystem-Opitimise.png" alt="GlusterFS-Filesystem-Opitimise" /></p>

<ul>
  <li>Performance.quick-read: ä¼˜åŒ–è¯»å–å°æ–‡ä»¶çš„æ€§èƒ½ã€‚</li>
  <li>Performance.read-ahead: ç”¨é¢„è¯»çš„æ–¹å¼æé«˜è¯»å–çš„æ€§èƒ½ï¼Œæœ‰åˆ©äºåº”ç”¨é¢‘ç¹æŒç»­æ€§çš„è®¿é—®æ–‡ä»¶ï¼Œå½“åº”ç”¨å®Œæˆå½“å‰æ•°æ®å—è¯»å–çš„æ—¶å€™ï¼Œä¸‹ä¸€ä¸ªæ•°æ®å—å°±å·²ç»å‡†å¤‡å¥½äº†ã€‚</li>
  <li>Performance.write-behind: åœ¨å†™æ•°æ®æ—¶ï¼Œå…ˆå†™å…¥ç¼“å­˜å†…ï¼Œå†å†™å…¥ç¡¬ç›˜ï¼Œä»¥æé«˜å†™å…¥çš„æ€§èƒ½ã€‚</li>
  <li>Performance.io-cache: ç¼“å­˜å·²ç»è¢«è¯»è¿‡çš„</li>
</ul>

<p>GlusterFS æ€§èƒ½å‚æ•°è°ƒæ•´æ–¹æ³•</p>

<blockquote>

  <p>gluster volume set <å·> <å‚æ•°></å‚æ•°></å·></p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@mystorage1 ~]# gluster volume <span class="nb">set </span>gv2 performance.read-ahead on
volume <span class="nb">set</span>: success
<span class="o">[</span>root@mystorage1 ~]# gluster volume <span class="nb">set </span>gv2 performance.cache-size 256MB
volume <span class="nb">set</span>: success
<span class="o">[</span>root@mystorage1 ~]# gluster volume info gv2
 
Volume Name: gv2
Type: Distributed-Replicate
Volume ID: 11928696-263a-4c7a-a155-5115af29221f
Status: Started
Number of Bricks: 2 x 2 <span class="o">=</span> 4
Transport-type: tcp
Bricks:
Brick1: mystorage1:/storage/brick2
Brick2: mystorage2:/storage/brick2
Brick3: mystorage3:/storage/brick1
Brick4: mystorage4:/storage/brick1
Options Reconfigured:
performance.cache-size: 256MB
performance.read-ahead: on
performance.readdir-ahead: on

<span class="c"># GlusterFS æ‰€æœ‰æ€§èƒ½å‚æ•°</span>
<span class="o">[</span>root@mystorage1 ~]# gluster volume <span class="nb">set </span>gv2 performance.
performance.cache-max-file-size              performance.force-readdirp                   performance.nfs.flush-behind                 performance.read-ahead
performance.cache-min-file-size              performance.high-prio-threads                performance.nfs.strict-o-direct              performance.read-ahead-page-count
performance.cache-priority                   performance.io-cache                         performance.nfs.strict-write-ordering        performance.readdir-ahead
performance.cache-refresh-timeout            performance.io-thread-count                  performance.nfs.write-behind                 performance.resync-failed-syncs-after-fsync
performance.cache-size                       performance.lazy-open                        performance.nfs.write-behind-window-size     performance.stat-prefetch
performance.cache-swift-metadata             performance.least-prio-threads               performance.normal-prio-threads              performance.strict-o-direct
performance.client-io-threads                performance.least-rate-limit                 performance.open-behind                      performance.strict-write-ordering
performance.enable-least-priority            performance.low-prio-threads                 performance.quick-read                       performance.write-behind
performance.flush-behind                     performance.md-cache-timeout                 performance.read-after-open                  performance.write-behind-window-size

</code></pre></div></div>

<h2 id="36-ç›‘æ§åŠæ—¥å¸¸ç»´æŠ¤">3.6 ç›‘æ§åŠæ—¥å¸¸ç»´æŠ¤</h2>

<p>å¯ä»¥ä½¿ç”¨ Zabbix è‡ªå¸¦æ¨¡æ¿ç›‘æ§ CPUã€å†…å­˜ã€ä¸»æœºå­˜æ´»ã€ç£ç›˜ç©ºé—´ã€ä¸»æœºè¿è¡Œæ—¶é—´ã€ç³»ç»Ÿ Load ç­‰ã€‚<br />
æ—¥å¸¸è¦æ³¨æ„æœåŠ¡å™¨çš„ç›‘æ§å€¼ï¼Œé‡åˆ°æŠ¥è­¦è¦åŠæ—¶å¤„ç†ã€‚</p>

<p>ä»¥ä¸‹å¤§å¤šæ•°åŠŸèƒ½æ˜¯é’ˆå¯¹åˆ†å¸ƒå¼å¤åˆ¶å·æ‰§è¡Œçš„ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æŸ¥çœ‹å·çš„çŠ¶æ€</span>
gluster volume status gv2 

<span class="c"># å¯åŠ¨å®Œå…¨ä¿®å¤</span>
gluster volume heal gv2 full

<span class="c"># æŸ¥çœ‹éœ€è¦ä¿®å¤çš„æ–‡ä»¶</span>
gluster volume heal gv2 info

<span class="c"># æŸ¥çœ‹ä¿®å¤æˆåŠŸçš„æ–‡ä»¶</span>
gluster volume heal gv2 info healed

<span class="c"># æŸ¥çœ‹ä¿®å¤å¤±è´¥çš„æ–‡ä»¶</span>
gluster volume heal gv2 info heal-failed

<span class="c"># æŸ¥çœ‹è„‘æ®‹çš„æ–‡ä»¶</span>
gluster volume heal gv2 info split-brain

<span class="c"># æ¿€æ´» quota åŠŸèƒ½</span>
gluster volume quota gv2 <span class="nb">enable</span>

<span class="c"># å…³é—­ quota åŠŸèƒ½</span>
gluster volume quota gv2 disable

<span class="c"># ç›®å½•å¤§å°é™åˆ¶ /data æ˜¯ç›¸å¯¹å·æŒ‚è½½ç‚¹çš„ç›®å½•ï¼Œä¸‹é¢æ˜¯æŒ‡ /gv2/data</span>
gluster volume quota gv2 limit-usage /data 30MB

<span class="c"># å†™å…¥ 40MB æ–‡ä»¶ æµ‹è¯• quota</span>
<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>40000 <span class="nv">of</span><span class="o">=</span>/gv2/data/40M.file

<span class="o">[</span>root@mystorage1 ~]# <span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>40000 <span class="nv">of</span><span class="o">=</span>/gv2/data/40M.file
40000+0 records <span class="k">in
</span>40000+0 records out
40960000 bytes <span class="o">(</span>41 MB<span class="o">)</span> copied, 7.53898 s, 5.4 MB/s
<span class="o">[</span>root@mystorage1 ~]# ll /gv2/data/40M.file 
<span class="nt">-rw-r--r--</span> 1 root root 40960000 Jul 30 08:09 /gv2/data/40M.file

<span class="c"># 40 MBçš„æ–‡ä»¶ç«Ÿç„¶å¯ä»¥ï¼Ÿä¸‹é¢ç»§ç»­å†™å…¥ä¸€ä¸ªå¤§ä¸€äº›çš„æ–‡ä»¶</span>
<span class="o">[</span>root@mystorage1 ~]# <span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>80000 <span class="nv">of</span><span class="o">=</span>/gv2/data/80M.file
<span class="nb">dd</span>: opening <span class="sb">`</span>/gv2/data/80M.file<span class="s1">': Disk quota exceeded

# è¿™æ¬¡æç¤ºè¶…è¿‡äº† quota ä¸èƒ½å†™å…¥ï¼Œè¯´æ˜ quota é™åˆ¶çš„ç›®å½•å¤§å°å¹¶ä¸æ˜¯é‚£ä¹ˆç²¾ç¡®ã€‚

# quota ä¿¡æ¯åˆ—è¡¨
gluster volume quota gv2 list

[root@mystorage1 ~]# gluster volume quota gv2 list
                  Path                   Hard-limit  Soft-limit      Used  Available  Soft-limit exceeded? Hard-limit exceeded?
-------------------------------------------------------------------------------------------------------------------------------
/data                                     30.0MB     80%(24.0MB)   0Bytes  30.0MB              No                   No

# é™åˆ¶ç›®å½•çš„ quota ä¿¡æ¯
gluster volume quota gv2 list /data

# è®¾ç½®ä¿¡æ¯çš„è¶…æ—¶æ—¶é—´
gluster volume set gv2 features.quota-timeout 5 

# åˆ é™¤æŸä¸ªç›®å½•çš„ quota è®¾ç½®
gluster volume quota gv2 remove /data

# å¤‡æ³¨ï¼šquota åŠŸèƒ½ï¼Œä¸»è¦æ˜¯å¯¹æŒ‚è½½ç‚¹ä¸‹çš„æŸä¸ªç›®å½•è¿›è¡Œç©ºé—´é™é¢ï¼Œè€Œä¸æ˜¯å¯¹ç»„æˆå·ç»„çš„ç©ºé—´è¿›è¡Œé™åˆ¶ã€‚
</span></code></pre></div></div>
:ET