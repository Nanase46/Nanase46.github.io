I"Á<h1 id="4-ç”Ÿäº§ç¯å¢ƒå¸¸è§æ•…éšœå¤„ç†">4 ç”Ÿäº§ç¯å¢ƒå¸¸è§æ•…éšœå¤„ç†</h1>

<blockquote>

  <p>ä¸€èˆ¬ç¡¬ç›˜ä¹Ÿè¦å¤‡ç”¨å‡ å—ï¼Œå› ä¸ºéšç€å‘å±•ï¼Œå¯èƒ½è¿™äº›å‹å·çš„ç¡¬ç›˜ä¸å¥½ä¹°åˆ°äº†ï¼Œä¸€èˆ¬çš„äº‹æ•…ä¸ä¼šåœ¨å¼€å§‹ä¸€ä¸¤å¹´å‡ºï¼Œ<br />
åœ¨ç¡¬ä»¶è€åŒ–çš„æ—¶å€™å‡ºæ•…éšœçš„é¢‘ç‡é«˜ã€‚</p>
</blockquote>

<h2 id="41-ç¡¬ç›˜æ•…éšœ">4.1 ç¡¬ç›˜æ•…éšœ</h2>

<p>å¦‚æœåº•å±‚åšäº† RAID é…ç½®ï¼Œæœ‰ç¡¬ä»¶æ•…éšœï¼Œç›´æ¥æ›´æ¢ç¡¬ç›˜ï¼Œä¼šè‡ªåŠ¨åŒæ­¥æ•°æ®ã€‚<br />
å¦‚æœæ²¡æœ‰åš RAIDï¼Œå¤„ç†æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<p>æ­£å¸¸èŠ‚ç‚¹ä¸Šæ‰§è¡Œ <code class="highlighter-rouge">gluster volume status</code>ï¼Œè®°å½•æ•…éšœèŠ‚ç‚¹ uuid<br />
æ‰§è¡Œï¼šgetfattr -d -m â€˜.*â€™ /brick
è®°å½• trusted.gluster.volume-id åŠ trusted.gfid</p>

<p>ä»¥ä¸‹ä¸ºæ•…éšœæ¨¡æ‹ŸåŠä¿®å¤è¿‡ç¨‹ï¼š</p>

<p>åœ¨ VMware Workstation ä¸Šç§»é™¤ mystorage1 ä¸»æœºçš„ç¬¬ä¸‰å—ç¡¬ç›˜ï¼ˆå¯¹åº” sdc /storage/brick2ï¼‰ï¼Œç›¸å½“äºç¡¬ç›˜æ•…éšœ</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c"># ç³»ç»Ÿæç¤ºå¦‚ä¸‹ï¼š</span>
Message from syslogd@linux-node01 at Jul 30 08:41:46 ...
 storage-brick2[5893]: <span class="o">[</span>2016-07-30 00:41:46.729896] M <span class="o">[</span>MSGID: 113075] <span class="o">[</span>posix-helpers.c:1844:posix_health_check_thread_proc] 0-gv2-posix: health-check failed, going down

Message from syslogd@linux-node01 at Jul 30 08:42:16 ...
 storage-brick2[5893]: <span class="o">[</span>2016-07-30 00:42:16.730518] M <span class="o">[</span>MSGID: 113075] <span class="o">[</span>posix-helpers.c:1850:posix_health_check_thread_proc] 0-gv2-posix: still alive! -&gt; SIGTERM

 <span class="c"># æŸ¥çœ‹å·çŠ¶æ€ï¼Œmystorage1:/storage/brick2 ä¸åœ¨çº¿äº†ï¼Œä¸è¿‡è¿™æ˜¯åˆ†å¸ƒå¼å¤åˆ¶å·ï¼Œè¿˜å¯ä»¥è®¿é—®å¦å¤– brick ä¸Šçš„æ•°æ®</span>
<span class="o">[</span>root@mystorage1 ~]# gluster volume status gv2 
Status of volume: gv2
Gluster process                             TCP Port  RDMA Port  Online  Pid
<span class="nt">------------------------------------------------------------------------------</span>
Brick mystorage1:/storage/brick2            N/A       N/A        N       N/A  

</code></pre></div></div>

<p>åœ¨ VMware Workstation ä¸Šæ–°å¢ mystorage1 ä¸€å—ç¡¬ç›˜ï¼Œç›¸å½“äºæ›´æ¢äº†æ–°ç¡¬ç›˜ï¼Œä¸‹é¢å…ˆæ ¼å¼æŒ‚è½½æ–°ç¡¬ç›˜ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
mkfs.xfs <span class="nt">-f</span> /dev/sdc
<span class="nb">mkdir</span> <span class="nt">-p</span> /storage/brick2
mount <span class="nt">-a</span>
<span class="nb">df</span> <span class="nt">-h</span>

<span class="c"># æ–°ç¡¬ç›˜æŒ‚è½½åç›®å½•ä¸ºç©º</span>
<span class="o">[</span>root@mystorage1 ~]# ll /storage/brick2
total 0

</code></pre></div></div>

<p>å¼€å§‹æ‰‹åŠ¨é…ç½®æ–°å¢ç¡¬ç›˜çš„ gluster å‚æ•°</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># åœ¨ mystorage2 æ˜¯è·å– glusterfs ç›¸å…³å‚æ•°ï¼š</span>
<span class="o">[</span>root@mystorage2 tmp]# getfattr <span class="nt">-d</span> <span class="nt">-m</span> <span class="s1">'.*'</span>  /storage/brick2
getfattr: Removing leading <span class="s1">'/'</span> from absolute path names
<span class="c"># file: storage/brick2</span>
trusted.gfid<span class="o">=</span><span class="nv">0sAAAAAAAAAAAAAAAAAAAAAQ</span><span class="o">==</span>
trusted.glusterfs.dht<span class="o">=</span>0sAAAAAQAAAAAAAAAAf////g<span class="o">==</span>
trusted.glusterfs.dht.commithash<span class="o">=</span><span class="s2">"3168624641"</span>
trusted.glusterfs.quota.dirty<span class="o">=</span><span class="nv">0sMAA</span><span class="o">=</span>
trusted.glusterfs.quota.size.1<span class="o">=</span>0sAAAAAATiAAAAAAAAAAAAAwAAAAAAAAAE
trusted.glusterfs.volume-id<span class="o">=</span><span class="nv">0sEZKGliY6THqhVVEVrykiHw</span><span class="o">==</span>

<span class="c"># åœ¨ mystorage1 ä¸Šæ‰§è¡Œé…ç½® glusterfs å‚æ•°å’Œä¸Šè¿°ä¸€æ ·</span>

setfattr <span class="nt">-n</span> trusted.gfid <span class="nt">-v</span> <span class="nv">0sAAAAAAAAAAAAAAAAAAAAAQ</span><span class="o">==</span> /storage/brick2
setfattr <span class="nt">-n</span> trusted.glusterfs.dht <span class="nt">-v</span> 0sAAAAAQAAAAAAAAAAf////g<span class="o">==</span> /storage/brick2
setfattr <span class="nt">-n</span> trusted.glusterfs.dht.commithash <span class="nt">-v</span> <span class="s2">"3168624641"</span> /storage/brick2
setfattr <span class="nt">-n</span> trusted.glusterfs.quota.dirty <span class="nt">-v</span> <span class="nv">0sMAA</span><span class="o">=</span> /storage/brick2
setfattr <span class="nt">-n</span> trusted.glusterfs.quota.size.1 <span class="nt">-v</span> 0sAAAAAATiAAAAAAAAAAAAAwAAAAAAAAAE /storage/brick2
setfattr <span class="nt">-n</span> trusted.glusterfs.volume-id <span class="nt">-v</span> <span class="nv">0sEZKGliY6THqhVVEVrykiHw</span><span class="o">==</span> /storage/brick2

<span class="o">[</span>root@mystorage1 ~]# /etc/init.d/glusterd restart
Starting glusterd:                                         <span class="o">[</span>  OK  <span class="o">]</span>


<span class="o">[</span>root@mystorage1 ~]# gluster volume heal gv2 info
Brick mystorage1:/storage/brick2
Status: Connected
Number of entries: 0

Brick mystorage2:/storage/brick2
/data 
Status: Connected
Number of entries: 1		<span class="c"># æ˜¾ç¤ºä¸€ä¸ªæ¡ç›®åœ¨ä¿®å¤ï¼Œè‡ªåŠ¨ä¿®å¤å®Œæˆåä¼šä¸º 0</span>

Brick mystorage3:/storage/brick1
Status: Connected
Number of entries: 0

Brick mystorage4:/storage/brick1
Status: Connected
Number of entries: 0

<span class="c"># è‡ªåŠ¨ä¿®å¤åŒæ­¥å®Œæˆåï¼ŒæŸ¥çœ‹æ–°ç¡¬ç›˜çš„æ•°æ®åŒæ­¥è¿‡æ¥äº†</span>
<span class="o">[</span>root@mystorage1 ~]# ll /storage/brick2
total 40012
<span class="nt">-rw-r--r--</span> 2 root root 20480000 Jul 30 02:41 20M.file
<span class="nt">-rw-r--r--</span> 2 root root 20480000 Jul 30 03:13 20M.file1
drwxr-xr-x 2 root root       21 Jul 30 09:14 data
</code></pre></div></div>

<h2 id="42-ä¸€å°ä¸»æœºæ•…éšœ">4.2 ä¸€å°ä¸»æœºæ•…éšœ</h2>

<p>ä¸€å°èŠ‚ç‚¹æ•…éšœçš„æƒ…å†µåŒ…å«ä»¥ä¸‹æƒ…å†µï¼š</p>

<ul>
  <li>ç‰©ç†æ•…éšœ</li>
  <li>åŒæ—¶æœ‰å¤šå—ç¡¬ç›˜æ•…éšœï¼Œé€ æˆæ•°æ®ä¸¢å¤±</li>
  <li>ç³»ç»ŸæŸåä¸å¯ä¿®å¤</li>
</ul>

<p>è§£å†³æ–¹æ³•ï¼š</p>

<p>æ‰¾ä¸€å°å®Œå…¨ä¸€æ ·çš„æœºå™¨ï¼Œè‡³å°‘è¦ä¿è¯ç¡¬ç›˜æ•°é‡å’Œå¤§å°ä¸€è‡´ï¼Œå®‰è£…ç³»ç»Ÿï¼Œé…ç½®å’Œæ•…éšœæœºåŒæ ·çš„ IPï¼Œå®‰è£… gluster è½¯ä»¶ï¼Œ<br />
ä¿è¯é…ç½®ä¸€æ ·ï¼Œåœ¨å…¶ä»–å¥åº·èŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤ <code class="highlighter-rouge">gluster peer status</code>ï¼ŒæŸ¥çœ‹æ•…éšœæœåŠ¡å™¨çš„ uuid</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@mystorage2 ~]# gluster peer status
Number of Peers: 3

Hostname: mystorage3
Uuid: 36e4c45c-466f-47b0-b829-dcd4a69ca2e7
State: Peer <span class="k">in </span>Cluster <span class="o">(</span>Connected<span class="o">)</span>

Hostname: mystorage4
Uuid: c607f6c2-bdcb-4768-bc82-4bc2243b1b7a
State: Peer <span class="k">in </span>Cluster <span class="o">(</span>Connected<span class="o">)</span>

Hostname: mystorage1
Uuid: 6e6a84af-ac7a-44eb-85c9-50f1f46acef1
State: Peer <span class="k">in </span>Cluster <span class="o">(</span>Disconnected<span class="o">)</span>
</code></pre></div></div>
<p>ä¿®æ”¹æ–°åŠ æœºå™¨çš„ /var/lib/glusterd/glusterd.info å’Œ æ•…éšœæœºå™¨ä¸€æ ·</p>

<blockquote>

  <p>[root@mystorage1 ~]# cat /var/lib/glusterd/glusterd.info<br />
UUID=6e6a84af-ac7a-44eb-85c9-50f1f46acef1<br />
operating-version=30712</p>
</blockquote>

<p>åœ¨ä¿¡ä»»å­˜å‚¨æ± ä¸­ä»»æ„èŠ‚ç‚¹æ‰§è¡Œ</p>

<blockquote>

  <p>gluster volume heal gv2 full</p>
</blockquote>

<p>å°±ä¼šè‡ªåŠ¨å¼€å§‹åŒæ­¥ï¼Œä½†åœ¨åŒæ­¥çš„æ—¶å€™ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½ã€‚</p>

<p>å¯ä»¥æŸ¥çœ‹çŠ¶æ€</p>

<blockquote>

  <p>gluster volume heal gv2 info</p>
</blockquote>

<h1 id="ref">Ref</h1>
<p><a href="http://udn.yyuap.com/thread-67733-1-1.html">KVMè™šæ‹ŸåŒ–å¼€æºé«˜å¯ç”¨æ–¹æ¡ˆ(ä¸ƒ)GLUSTERFSæ­å»ºåŠå¸¸è§æ•…éšœå¤„ç†</a><br />
<a href="http://www.sklinux.com/1435">Glusterfsé›†ç¾¤åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿæ‰brickçš„å¤„ç†</a></p>
:ET