I"ñ+<h1 id="saltstack-syndic-ä»‹ç»">SaltStack Syndic ä»‹ç»</h1>

<p>æˆ‘ä»¬ä½¿ç”¨å¤š Mater çš„åŠŸèƒ½è§£å†³äº† Master å•ç‚¹æ•…éšœçš„é—®é¢˜ï¼Œé‚£ä¹ˆä¿è¯é«˜å¯ç”¨ä¹‹åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦è€ƒè™‘çš„å°±æ˜¯æ€§èƒ½äº†ï¼Œ<br />
æ˜¯çš„ï¼Œå¦‚æœä½ ç®¡ç†çš„ Minion æ•°ä»¥ä¸‡è®¡ï¼Œä¸€ä¸ª Master å¯èƒ½å°±æœ‰ä¸€äº›åƒåŠ›äº†ï¼Œæˆ‘ä»¬éœ€è¦æ›´åŠ çµæ´»çš„æ¶æ„ï¼Œé‚£ä¹ˆè¯¥ Salt Syndic å‡ºåœºäº†ã€‚</p>

<p>ä¸€ä¸ªåŸºæœ¬çš„ Salt é…ç½®æ–¹å¼æ˜¯ä¸€ä¸ª Master ç®¡ç†ä¸€ç¾¤ Minionï¼Œè¿™å°±æ˜¯å•ä¸€çš„æ‹“æ‰‘ç»“æ„ã€‚é‚£ä¹ˆä¸ºäº†å¢åŠ å¤šç§æ‹“æ‰‘æ¶æ„çš„æ”¯æŒï¼ŒSalt åœ¨ 0.9.0 ç‰ˆæœ¬ä¸­åŠ å…¥äº† Salt Syndicã€‚Syndic å»ºç«‹åœ¨ä¸­å¿ƒ Master å’Œ Minions ä¹‹é—´ï¼Œå¹¶å…è®¸å¤šå±‚åˆ†çº§ Syndicã€‚</p>

<p>Syndic è¿è¡Œåœ¨ä¸€ä¸ª Master ä¸Šï¼Œå¹¶ä¸”è¿æ¥åˆ°å¦å¤–ä¸€ä¸ª Masterï¼ˆæ¯”å®ƒæ›´é«˜çº§åˆ«ï¼Œæˆ‘ä»¬åé¢ç§°ä¹‹ä¸ºâ€œé«˜çº§ Masterâ€ï¼‰ï¼Œè¿™é‡Œéœ€è¦å¼ºè°ƒçš„æ˜¯ Syndic å¿…é¡»è¿è¡Œåœ¨ä¸€ä¸ª Master ä¸Šã€‚</p>

<p>ç„¶å Syndic Minion æ‰€è¿æ¥çš„é«˜çº§ Master å°±å¯ä»¥æ§åˆ¶è¿æ¥åˆ°è¿è¡Œ Syndic çš„ Master ä¸Š çš„ Minionã€‚è¿™å¥è¯ç¨æœ‰ç‚¹ç»•ï¼Œå¦‚æœä¸€ä¸‹å­æ²¡æ˜ç™½ï¼Œå…ˆåŠ æ·±ç‚¹è®°å¿†â€œSyndic å¿…é¡»è¿è¡Œåœ¨ä¸€ä¸ª Master ä¸Šâ€ï¼Œç„¶åå†å›è¿‡å¤´çœ‹å°±å¥½ç†è§£äº†ã€‚</p>

<h1 id="1-syndic-é…ç½®">1 Syndic é…ç½®</h1>

<p>Syndic å¯¹äºå®ƒç®¡ç†çš„ Minion æ¥è¯´ï¼Œå°±æ˜¯ä¸€ä¸ª Master èŠ‚ç‚¹ï¼Œæ‰€ä»¥ Syndic æ²¡æœ‰è‡ªå·±çš„é…ç½®æ–‡ä»¶ï¼Œå®ƒæ˜¯ Salt Master çš„ä¸€ä¸ªç»„ä»¶ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linux-node1 ~]# yum <span class="nb">install </span>salt-syndic <span class="nt">-y</span>
<span class="o">[</span>root@linux-node1 ~]# vim /etc/salt/master
syndic_master: 192.168.56.12	<span class="c"># è®¾ç½®ä¸ºé«˜çº§ Master çš„ IP</span>
<span class="o">[</span>root@linux-node1 ~]# systemctl restart salt-master
<span class="o">[</span>root@linux-node1 ~]# systemctl start salt-syndic
</code></pre></div></div>

<h1 id="2-é«˜çº§-master-é…ç½®">2 é«˜çº§ Master é…ç½®</h1>

<p>é«˜çº§ Master éœ€è¦ä½¿ç”¨ order_masters å‚æ•°æ¥è¿›è¡Œå¼€å¯ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linux-node2 ~]# yum <span class="nb">install </span>salt-master <span class="nt">-y</span>
<span class="o">[</span>root@linux-node2 ~]# <span class="nb">grep</span> <span class="s2">"order_masters"</span> /etc/salt/master
order_masters: True
<span class="o">[</span>root@linux-node1 ~]# systemctl start salt-master
</code></pre></div></div>

<p>å¯åŠ¨ä¹‹åï¼Œåœ¨é«˜çº§ Master ä¸Šé€šè¿‡ salt-key å¯ä»¥çœ‹åˆ°ï¼ŒSalt Syndic å·²ç»è¿æ¥ä¸Šæ¥äº†ï¼Œåœ¨å‰é¢æˆ‘ä»¬æåˆ°è¿‡ Syndic èŠ‚ç‚¹å¯¹äºå®ƒç®¡ç†çš„ Minion æ¥è¯´å°±æ˜¯ä¸€ä¸ª Masterï¼Œä½†æ˜¯ Syndic å¯¹äºé«˜çº§ Master æ¥è¯´ï¼Œå®ƒå´æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Minionï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linux-node2 ~]# salt-key <span class="nt">-L</span>
Accepted Keys:
Denied Keys:
Unaccepted Keys:
linux-node1.example.com
Rejected Keys:
</code></pre></div></div>

<h1 id="3-syndic-æµ‹è¯•">3 Syndic æµ‹è¯•</h1>

<p>é«˜çº§ Master å¯ä»¥æ§åˆ¶ä¸€ç¾¤åŒæ—¶è¿è¡Œç€â€œsyndic å’Œ masterâ€çš„èŠ‚ç‚¹ï¼Œé€šè¿‡ Syndic å°†æ“ä½œå‘½ä»¤ä¼ è¾“ç»™å—æ§ Masterï¼Œå—æ§ Master æ¥å®Œæˆå¯¹è‡ªå·±æ——ä¸‹ Minion çš„ç®¡ç†ï¼Œå¹¶å°†ç»“æœä¼ å›é«˜çº§ Masterï¼Œä»è€Œå®ç°é«˜çº§ Master å¯¹æ‰€æœ‰ Minion çš„é—´æ¥ç®¡ç†ã€‚</p>

<p>é«˜çº§ Master åŒæ„ Syndic èŠ‚ç‚¹çš„è¿æ¥åï¼Œä½¿ç”¨ test.ping å°±å¯ä»¥çœ‹åˆ°ï¼Œé«˜çº§ Master å¯ä»¥ç®¡ç†æ‰€æœ‰è¿æ¥åˆ° Syndic ä¸Šé¢çš„ Minionï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linux-node2 ~]# salt-key <span class="nt">-A</span>
<span class="o">[</span>root@linux-node2 ~]# salt <span class="s1">'*'</span> test.ping
linux-node1.example.com:
    True
linux-node2.example.com:
    True
</code></pre></div></div>

<h1 id="4-syndic-æ˜¯å¦‚ä½•å·¥ä½œçš„">4 Syndic æ˜¯å¦‚ä½•å·¥ä½œçš„</h1>

<p>Syndic æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Minionï¼Œå…¶ä»£ç å°±ä½äº minion.py ä¸­ã€‚
Syndic éœ€è¦åœ¨æœ¬åœ°è¿è¡Œ Masterï¼Œå¹¶å°†éœ€è¦ç®¡ç†çš„ Minions çš„ Master æŒ‡å‘ Syndic æ‰€åœ¨çš„ä¸»æœºã€‚Syndic æ˜¯è¿™ä¹ˆæ¥å·¥ä½œçš„ï¼š</p>

<ul>
  <li>å†’å…… Minionï¼Œå»ºç«‹ä¸é«˜çº§åˆ«çš„ Master çš„è¿æ¥ï¼Œè®¢é˜…æ‰€æœ‰æ¥è‡ªé«˜çº§ Master ä¸‹å‘çš„ä»»åŠ¡ã€‚</li>
  <li>æ¥æ”¶é«˜çº§ Master ä¸‹å‘çš„æ•°æ®åï¼Œé¦–å…ˆè¿›è¡Œè§£å¯†ï¼Œè§£å¯†å®Œæˆåï¼Œå°†å…¶æ‰”åˆ°æœ¬åœ°çš„ Master æ¥å£ä¸Šè¿›è¡ŒäºŒæ¬¡ä¸‹å‘ã€‚</li>
  <li>Syndic åœ¨è¿›è¡ŒäºŒæ¬¡ä¸‹å‘ä¹‹åï¼Œç›‘å¬æœ¬åœ° Event æ¥å£ï¼Œè·å–æ‰€ç®¡ç†çš„ Minions çš„è¿”å›ã€‚</li>
  <li>å°†è¿”å›å‘é€ç»™é«˜çº§ Masterã€‚</li>
</ul>

<h1 id="5-syndic-çš„ä¼˜ç¼ºç‚¹">5 Syndic çš„ä¼˜ç¼ºç‚¹</h1>

<p>æ²¡æœ‰çœŸæ­£å®Œç¾çš„æ¶æ„ï¼Œä½¿ç”¨ Syndic è™½ç„¶å¯ä»¥å»ºç«‹å¤šå±‚çš„ Salt æ‹“æ‰‘ï¼Œä½†ä¹Ÿæ˜¯æœ‰åˆ©æœ‰å¼Šï¼Œéœ€è¦ä½¿ç”¨è€…æ ¹æ®å®é™…çš„éœ€æ±‚è¿›è¡Œæƒè¡¡ã€‚</p>

<h2 id="ä¼˜ç‚¹">ä¼˜ç‚¹</h2>

<ul>
  <li>é€šè¿‡ Syndicï¼Œå¯ä»¥å»ºç«‹å¤šå±‚çº§çš„ Salt æ‹“æ‰‘ï¼ŒSyndic ä¸‹çš„ Minions å³å¯é€šè¿‡ Syndic æ‰€åœ¨çš„ Master è¿›è¡Œç®¡ç†ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é«˜çº§ Master è¿›è¡Œç®¡ç†ï¼Œæ¶æ„å˜å¾—å¼‚å¸¸çµæ´»ã€‚</li>
  <li>ç”±äº Syndic åªè®¢é˜…é«˜çº§ Master ä¸‹å‘ä¸‹æ¥çš„ä»»åŠ¡ï¼Œå¯¹äºæ–‡ä»¶æœåŠ¡ç­‰ï¼ŒSyndic æœ¬åœ°è¿›è¡Œé…ç½®ï¼Œå¯ä»¥æœ‰æ•ˆåœ°é™ä½é«˜çº§ Master çš„è´Ÿè½½ã€‚</li>
</ul>

<h2 id="ç¼ºç‚¹">ç¼ºç‚¹</h2>

<ul>
  <li>éœ€è¦ä¿è¯ Syndic ä¸Šçš„ file_roots åŠ pillar_roots ä¸é«˜çº§ Master æ˜¯ä¸€è‡´çš„ã€‚</li>
  <li>ç”±äº Syndic ç®¡ç†äº†æ——ä¸‹ Minions çš„è®¤è¯ï¼Œè¿™æ ·é«˜çº§ Master å¹¶ä¸çŸ¥é“æœ‰å¤šå°‘ Syndic ä¸»æœºï¼ŒSyndic ä¸‹è¾¹æœ‰å¤šå°‘ Minionsã€‚
åœ¨é«˜çº§ Master ä¸Šä½¿ç”¨ Salt å‘½ä»¤è¡Œä¸‹å‘è¿œç¨‹æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œ<strong>å¦‚æœ Syndic æ­¤æ—¶ä¸é«˜çº§ Master ç½‘ç»œä¹‹é—´æœ‰æŠ–åŠ¨ï¼Œå¯¼è‡´æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯æˆ–å»¶è¿Ÿæ”¶åˆ°æ¶ˆæ¯ï¼Œ
é«˜çº§ Master å¹¶ä¸çŸ¥æƒ…ã€‚Syndic å¹¶æ²¡æœ‰è¿”å›ç»“æœæˆ–å»¶è¿Ÿè¿”å›ç»“æœï¼Œé«˜çº§ Master å¹¶ä¸èƒ½æ„ŸçŸ¥åˆ°ï¼Œä¼šå¯¼è‡´ç»“æœä¸å®Œæ•´ã€‚</strong>
å¦‚æœæ²¡æœ‰å…¶ä»–éªŒè¯æœºåˆ¶ï¼Œç»“æœå°†å˜å¾—ä¸å¯æ§ã€‚å®˜æ–¹æä¾›çš„è§£å†³æ–¹æ¡ˆæ˜¯å¢å¤§ syndic_wait é€‰é¡¹ï¼Œä½†æ˜¯åªèƒ½ç¼“è§£ï¼Œå¹¶ä¸èƒ½æ ¹æ²»é—®é¢˜ã€‚</li>
</ul>

<h2 id="å»ºè®®">å»ºè®®</h2>
<p>æ²¡æœ‰ç³»ç»Ÿæˆ–å·¥å…·æ˜¯ 100% å¯é çš„ã€‚åŸºäºè¿™ä¸€è§‚ç‚¹ï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨ Salt çš„æ¶æ„æ‰©å±•ï¼Œå¯¹äºè¿ç»´ä½¿ç”¨ SaltStack æ¥è¯´ï¼Œ
å¦‚æœèƒ½ä»æµç¨‹ä¸Šå¯¹æ¯æ¬¡ SaltStack çš„æ‰§è¡Œç»“æœè¿›è¡Œæ£€æŸ¥å’ŒéªŒè¯ï¼Œæ˜¯æ¯”è¾ƒç¨³å¦¥çš„æ–¹æ¡ˆï¼Œå¯èƒ½ä¹Ÿç®—æ˜¯æ¯”è¾ƒä¿å®ˆå§ã€‚</p>

<h1 id="é‡åˆ°çš„é—®é¢˜">é‡åˆ°çš„é—®é¢˜</h1>

<p>1.ä½¿ç”¨ä¹‹å‰é…ç½®çš„ç¯å¢ƒï¼Œlinux-node1 æ˜¯æ—  Master æ¶æ„ï¼Œè¿˜æœ‰å…¶ä»–æŠ¥é”™ã€‚</p>

<p>å¤„ç†æ–¹æ³•ï¼šæœ€ç®€åŒ– Salt Master å’Œ Minion çš„é…ç½®ï¼Œæ’é™¤å…¶ä»–åŸå› ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linux-node1 ~]# <span class="nb">cat</span> /etc/salt/master
syndic_master: 192.168.56.12
<span class="o">[</span>root@linux-node1 ~]# <span class="nb">cat</span> /etc/salt/minion
master: 192.168.56.11

<span class="o">[</span>root@linux-node2 ~]# <span class="nb">cat</span> /etc/salt/master
order_masters: True
<span class="o">[</span>root@linux-node2 ~]# <span class="nb">cat</span> /etc/salt/minion
master: 192.168.56.11
</code></pre></div></div>

<p>2.ç»è¿‡ç¬¬ 1 æ­¥å¤„ç†ï¼Œè¿˜æœ‰å¦‚ä¸‹æŠ¥é”™ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linux-node1 ~]# systemctl status salt-syndic
â— salt-syndic.service - The Salt Master Server
   Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/salt-syndic.service<span class="p">;</span> disabled<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
   Active: failed <span class="o">(</span>Result: exit-code<span class="o">)</span> since Mon 2016-08-01 18:45:20 CST<span class="p">;</span> 11s ago
  Process: 22082 <span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/salt-syndic <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>1/FAILURE<span class="o">)</span>
 Main PID: 22082 <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>1/FAILURE<span class="o">)</span>

Aug 01 18:45:20 linux-node1.example.com salt-syndic[22082]: <span class="o">[</span>ERROR   <span class="o">]</span> The master key has changed, the salt master could have been subverted, verify salt master<span class="s1">'s public key
Aug 01 18:45:20 linux-node1.example.com salt-syndic[22082]: [CRITICAL] The Salt Master server'</span>s public key did not authenticate!
Aug 01 18:45:20 linux-node1.example.com salt-syndic[22082]: The master may need to be updated <span class="k">if </span>it is a version of Salt lower than 2016.3.1, or
Aug 01 18:45:20 linux-node1.example.com salt-syndic[22082]: If you are confident that you are connecting to a valid Salt Master, <span class="k">then </span>remove the master public key and restart the Salt Minion.
Aug 01 18:45:20 linux-node1.example.com salt-syndic[22082]: The master public key can be found at:
Aug 01 18:45:20 linux-node1.example.com salt-syndic[22082]: /etc/salt/pki/minion/syndic_master.pub
Aug 01 18:45:20 linux-node1.example.com salt-syndic[22082]: Invalid master key
Aug 01 18:45:20 linux-node1.example.com systemd[1]: salt-syndic.service: main process exited, <span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>1/FAILURE
Aug 01 18:45:20 linux-node1.example.com systemd[1]: Unit salt-syndic.service entered failed state.
Aug 01 18:45:20 linux-node1.example.com systemd[1]: salt-syndic.service failed.


<span class="c"># ä»¥ä¸Šé”™è¯¯æç¤º master key æ”¹å˜äº†ï¼Œå¯ä»¥å°è¯•ç§»é™¤ master å…¬é’¥ï¼Œç„¶åé‡å¯ minion</span>

<span class="o">[</span>root@linux-node1 ~]# ll /etc/salt/pki/minion/
total 16
<span class="nt">-rw-r--r--</span> 1 root root  450 Jun 29 15:48 minion_master.pub
<span class="nt">-r--------</span> 1 root root 1674 Jun 29 15:48 minion.pem
<span class="nt">-rw-r--r--</span> 1 root root  450 Jun 29 15:48 minion.pub
<span class="nt">-rw-r--r--</span> 1 root root  450 Aug  1 15:59 syndic_master.pub		<span class="c"># è¿™ä¸ª master å…¬é’¥æ˜¯ä¹‹å‰é…ç½®ç”Ÿæˆçš„ï¼Œéœ€è¦åˆ é™¤</span>
<span class="o">[</span>root@linux-node1 ~]# <span class="nb">rm</span> <span class="nt">-f</span> /etc/salt/pki/minion/syndic_master.pub 
<span class="o">[</span>root@linux-node1 ~]# systemctl restart salt-syndic

<span class="o">[</span>root@linux-node1 ~]# ll /etc/salt/pki/minion/
total 16
<span class="nt">-rw-r--r--</span> 1 root root  450 Jun 29 15:48 minion_master.pub
<span class="nt">-r--------</span> 1 root root 1674 Jun 29 15:48 minion.pem
<span class="nt">-rw-r--r--</span> 1 root root  450 Jun 29 15:48 minion.pub
<span class="nt">-rw-r--r--</span> 1 root root  450 Aug  1 18:59 syndic_master.pub		<span class="c"># é‡å¯ salt-syndic åï¼Œmaster å…¬é’¥é‡æ–°ç”Ÿæˆäº†</span>

</code></pre></div></div>

<h1 id="ref">Ref</h1>
<p><a href="https://docs.saltstack.com/en/latest/topics/topology/syndic.html">SALT SYNDIC</a></p>
:ET