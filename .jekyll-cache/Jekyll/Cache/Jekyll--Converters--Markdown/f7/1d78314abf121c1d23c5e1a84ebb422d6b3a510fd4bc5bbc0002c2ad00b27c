I"»(<h1 id="ä»€ä¹ˆæ˜¯-jinja2">ä»€ä¹ˆæ˜¯ Jinja2</h1>

<pre>

Jinja2 æ˜¯ä¸€ä¸ª Python çš„åŠŸèƒ½é½å…¨çš„æ¨¡æ¿å¼•æ“ã€‚
å®ƒæœ‰å®Œæ•´çš„ unicode æ”¯æŒï¼Œä¸€ä¸ªå¯é€‰çš„é›†æˆæ²™ç®±æ‰§è¡Œç¯å¢ƒï¼Œè¢«å¹¿æ³›ä½¿ç”¨ï¼Œä»¥ BSD è®¸å¯è¯æˆæƒã€‚

Jinja2 æ˜¯ä¸€ä¸ªç°ä»£çš„ï¼Œè®¾è®¡è€…å‹å¥½çš„ï¼Œä»¿ç…§ Django æ¨¡æ¿çš„ Python æ¨¡æ¿è¯­è¨€ã€‚ 
å®ƒé€Ÿåº¦å¿«ï¼Œè¢«å¹¿æ³›ä½¿ç”¨ï¼Œå¹¶ä¸”æä¾›äº†å¯é€‰çš„æ²™ç®±æ¨¡æ¿æ‰§è¡Œç¯å¢ƒä¿è¯å®‰å…¨ã€‚

ç‰¹æ€§:
æ²™ç®±ä¸­æ‰§è¡Œ
å¼ºå¤§çš„ HTML è‡ªåŠ¨è½¬ä¹‰ç³»ç»Ÿä¿æŠ¤ç³»ç»Ÿå…å— XSS
æ¨¡æ¿ç»§æ‰¿
å³æ—¶ç¼–è¯‘æœ€ä¼˜çš„ Python ä»£ç 
å¯é€‰æå‰ç¼–è¯‘æ¨¡æ¿çš„æ—¶é—´
æ˜“äºè°ƒè¯•ï¼Œå¼‚å¸¸çš„è¡Œæ•°ç›´æ¥æŒ‡å‘æ¨¡æ¿ä¸­çš„å¯¹åº”è¡Œã€‚
å¯é…ç½®çš„è¯­æ³•

</pre>

<h1 id="salt-ä½¿ç”¨-jinja2-æ¨¡æ¿">Salt ä½¿ç”¨ Jinja2 æ¨¡æ¿</h1>

<pre>

SaltStack æ˜¯ä½¿ç”¨ YAML è¯­è¨€æ¥å°† SLS æ–‡ä»¶è§£é‡Šæˆå®ƒè‡ªå·±å¯ä»¥è¯†åˆ«çš„å†…å®¹ï¼ŒJinja æ˜¯ä¸€ç§åŸºäº Python çš„æ¨¡æ¿å¼•æ“ï¼Œ
åœ¨ SLS æ–‡ä»¶é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Jinja æ¨¡æ¿æ¥åšä¸€äº›æ“ä½œã€‚
æ¯”å¦‚å½“æˆ‘ä»¬éœ€è¦å¯¹å¤šå°æœåŠ¡å™¨åšä¸€äº› Apache æœåŠ¡é…ç½®æ—¶ï¼Œç”±äºæ¯å°æœåŠ¡å™¨ä¿¡æ¯ä¸ä¸€æ ·ï¼ˆæ¯”å¦‚ IP ä¸åŒï¼‰ï¼Œ
å¦‚æœä¸ºæ¯å°æœåŠ¡å™¨å»åˆ›å»º SLS æ–‡ä»¶å°±ä¸å¤ªåˆç†ï¼Œè€Œé€šè¿‡ Jinja æ¨¡æ¿åˆ™å¯ä»¥ç”¨ç”Ÿæˆå˜é‡â†’è¯»å–å˜é‡çš„æ–¹å¼æ¥ä¸ºæ¯ä¸ªæœåŠ¡å™¨è®¾ç½®åº”æœ‰çš„ä¿¡æ¯ã€‚

</pre>

<h2 id="1-ä½¿ç”¨-jinja2-æ¨¡æ¿çš„ä¸‰æ­¥">1 ä½¿ç”¨ Jinja2 æ¨¡æ¿çš„ä¸‰æ­¥</h2>

<p>1.å‘Šè¯‰ file æ¨¡å—ï¼Œè¦ä½¿ç”¨ jinja<br />
2.åˆ—å‡ºå‚æ•°åˆ—è¡¨<br />
å¦‚ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apache-config:
  file.managed:
    - name: /etc/httpd/conf/httpd.conf
    - <span class="nb">source</span>: salt://lamp/files/httpd.conf
    - user: root
    - group: root
    - mode: 644
    - template: jinja    <span class="c"># 1. å¢åŠ è¿™è¡Œè¡¨ç¤ºå¼€å¯æ¨¡æ¿</span>
    - defaults:          <span class="c"># 2. ä¸‹é¢è®¾å®šå˜é‡çš„å€¼</span>
      PORT: 88
</code></pre></div></div>

<p>3.æ–‡ä»¶ä¸­æ¨¡æ¿å˜é‡å¼•ç”¨</p>

<p><strong>æ¨¡æ¿é‡Œé¢æ”¯æŒ salt/grains/pillar è¿›è¡Œå˜é‡èµ‹å€¼</strong></p>

<p>ä¸‹é¢åˆ†åˆ«è¿›è¡Œä¸¾ä¾‹</p>

<h2 id="2-jinja2-æ¨¡æ¿çš„åŸºæœ¬ä½¿ç”¨">2 Jinja2 æ¨¡æ¿çš„åŸºæœ¬ä½¿ç”¨</h2>

<p>1.é¦–å…ˆå°† source æ–‡ä»¶ä¸­éœ€è¦å¼•ç”¨å˜é‡çš„å†…å®¹æ”¹ä¸ºï¼Œå¦‚ä¿®æ”¹ apache é…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£ä¿¡æ¯:</p>

<p>å°† Listen 80 ä¿®æ”¹æˆ Listen</p>

<p>2.å¯¹ SLS æ–‡ä»¶è¿›è¡Œç¼–è¾‘ä»¥å®šä¹‰æ¨¡æ¿å¹¶ä¸”ç»™å˜é‡ä¼ å€¼ï¼Œåœ¨ç¬¬ä¸€æ­¥ä¸­å®šä¹‰äº†å‡ ä¸ªå˜é‡å°±å¿…é¡»ç»™å‡ ä¸ªå˜é‡ä¼ å€¼  <br />
é…ç½® apache-config çš„çŠ¶æ€å¦‚ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apache-config:
  file.managed:
    - name: /etc/httpd/conf/httpd.conf
    - <span class="nb">source</span>: salt://lamp/files/httpd.conf
    - user: root
    - group: root
    - mode: 644
    - template: jinja    <span class="c"># å¢åŠ è¿™è¡Œè¡¨ç¤ºå¼€å¯æ¨¡æ¿</span>
    - defaults:          <span class="c"># ä¸‹é¢è®¾å®šå˜é‡çš„å€¼</span>
      PORT: 88
</code></pre></div></div>

<p>3.æ‰§è¡Œ state.sls  <br />
è¾“å‡ºå¦‚ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">----------</span>
          ID: apache-config
    Function: file.managed
        Name: /etc/httpd/conf/httpd.conf
      Result: None
     Comment: The file /etc/httpd/conf/httpd.conf is <span class="nb">set </span>to be changed
     Started: 16:23:32.575140
    Duration: 80.33 ms
     Changes:   
              <span class="nt">----------</span>
              diff:
                  <span class="nt">---</span> 
                  +++ 
                  @@ <span class="nt">-39</span>,7 +39,7 @@
                   <span class="c"># prevent Apache from glomming onto all bound IP addresses.</span>
                   <span class="c">#</span>
                   <span class="c">#Listen 12.34.56.78:80</span>
                  <span class="nt">-Listen</span> 80
                  +Listen 88
                   
                   <span class="c">#</span>
                   <span class="c"># Dynamic Shared Object (DSO) Support</span>
<span class="nt">----------</span>
</code></pre></div></div>

<h2 id="3-jinja2-æ¨¡æ¿çš„é«˜çº§ä½¿ç”¨">3 Jinja2 æ¨¡æ¿çš„é«˜çº§ä½¿ç”¨</h2>

<p>åœ¨åŸºæœ¬ä½¿ç”¨ä¸­ç”±äºä¿®æ”¹çš„æ˜¯ç«¯å£ï¼Œç«¯å£ä¿¡æ¯ä¸€èˆ¬æ˜¯å›ºå®šçš„ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹çš„ä¿¡æ¯æ˜¯æ¯ä¸ª minion è‡ªèº«çš„ IP å°±æ²¡åŠæ³•è®¾ç½®ä¸€ä¸ªé€šç”¨çš„ä¿¡æ¯äº†ï¼Œ
è¿™ä¸ªæ—¶å€™éœ€è¦é€šè¿‡å…¶ä»–æ–¹æ³•æ¥è·å– minion ç›¸å…³ä¿¡æ¯ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ Grains ã€Pillar å’Œæ‰§è¡Œæ¨¡å—ä¸‰ä¸ªæ–¹æ³•æ¥è·å–ã€‚</p>

<h3 id="31-ç”¨-grains-ä¸¾ä¾‹-è®¾ç½®-ip">3.1 ç”¨ Grains ä¸¾ä¾‹-è®¾ç½® IP</h3>

<p>å¢åŠ çš„é…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    - template: jinja
    - defaults:
      PORT: 88
      HOST: 
      <span class="c"># [fqdn_ip4]ä»£è¡¨çš„æ˜¯ IPï¼Œè¯¥ä¿¡æ¯éœ€è¦å…ˆæ‰§è¡Œ salt '*' grains.items æŸ¥è¯¢ï¼Œç”±äº grains </span>
      <span class="c"># æŸ¥è¯¢è¾“å‡ºçš„æ˜¯åˆ—è¡¨ï¼Œä¼šæœ‰å¤šä¸ªå€¼ï¼Œéœ€è¦åŠ ä¸Š[0]ä»£è¡¨å–ç¬¬ä¸€ä¸ªå€¼</span>
</code></pre></div></div>

<p>åŒæ ·éœ€è¦ä¿®æ”¹ httpd.conf æ–‡ä»¶å¼•ç”¨ä¸Šé¢å®šä¹‰çš„æ¨¡æ¿å˜é‡ï¼Œå¦‚ä¸‹ï¼š</p>
<blockquote>

  <p>Listen :</p>
</blockquote>

<p>æ‰§è¡Œ state.sls<br />
è¾“å‡ºå¦‚ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">----------</span>
          ID: apache-config
    Function: file.managed
        Name: /etc/httpd/conf/httpd.conf
      Result: None
     Comment: The file /etc/httpd/conf/httpd.conf is <span class="nb">set </span>to be changed
     Started: 16:38:42.643145
    Duration: 37.981 ms
     Changes:   
              <span class="nt">----------</span>
              diff:
                  <span class="nt">---</span> 
                  +++ 
                  @@ <span class="nt">-39</span>,7 +39,7 @@
                   <span class="c"># prevent Apache from glomming onto all bound IP addresses.</span>
                   <span class="c">#</span>
                   <span class="c">#Listen 12.34.56.78:80</span>
                  <span class="nt">-Listen</span> 88
                  +Listen 192.168.56.12:88
                   
                   <span class="c">#</span>
                   <span class="c"># Dynamic Shared Object (DSO) Support</span>
<span class="nt">----------</span>
</code></pre></div></div>

<h3 id="32-ä½¿ç”¨-salt-è¿œç¨‹æ‰§è¡Œæ¨¡å—-ä¸¾ä¾‹-è·å–ç½‘å¡-mac-åœ°å€">3.2 ä½¿ç”¨ Salt è¿œç¨‹æ‰§è¡Œæ¨¡å— ä¸¾ä¾‹-è·å–ç½‘å¡ MAC åœ°å€</h3>

<p>ä»¥ä¸‹ä¸ºæ¼”ç¤ºï¼ˆè¿œç¨‹å‘½ä»¤ç›´æ¥å†™åœ¨ httpd.conf ä¸­ï¼Œä¸ºæ³¨é‡ŠçŠ¶æ€ï¼‰</p>

<pre>
Listen : Â 
# The MAC is: 
</pre>

<p>æ‰§è¡Œ state.sls åçš„è¾“å‡ºå¦‚ä¸‹(æˆªå–éƒ¨åˆ†)ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">----------</span>
          ID: apache-config
    Function: file.managed
        Name: /etc/httpd/conf/httpd.conf
      Result: None
     Comment: The file /etc/httpd/conf/httpd.conf is <span class="nb">set </span>to be changed
     Started: 16:47:28.887669
    Duration: 51.994 ms
     Changes:   
              <span class="nt">----------</span>
              diff:
                  <span class="nt">---</span> 
                  +++ 
                  @@ <span class="nt">-39</span>,7 +39,8 @@
                   <span class="c"># prevent Apache from glomming onto all bound IP addresses.</span>
                   <span class="c">#</span>
                   <span class="c">#Listen 12.34.56.78:80</span>
                  <span class="nt">-Listen</span> 88
                  +Listen 192.168.56.12:88
                  +# The MAC is: 00:0c:29:bf:c0:16    <span class="c"># å¯ä»¥çœ‹åˆ°ï¼Œå–åˆ°äº† MAC åœ°å€</span>
                   
                   <span class="c">#</span>
                   <span class="c"># Dynamic Shared Object (DSO) Support</span>
<span class="nt">----------</span>

</code></pre></div></div>

<h3 id="33-ä½¿ç”¨-phillar---ä¸¾ä¾‹">3.3 ä½¿ç”¨ Phillar - ä¸¾ä¾‹</h3>

<p>ä¸€èˆ¬ç”¨äºé…ç½®ç”¨æˆ·åå¯†ç çš„æ—¶å€™<br />
ä»¥ä¸‹ä¸ºæ¼”ç¤ºï¼ˆ Phillar é…ç½®åŠ åˆ° httpd.conf ä¸­ï¼Œä¸ºæ³¨é‡ŠçŠ¶æ€ï¼‰</p>

<pre>
# Pillar test: User: salt Password: 
</pre>

<p>pillar[â€˜apacheâ€™] å·²åœ¨ Salt Master ä¸Šé…ç½®å¥½ï¼Œå¯ä»¥å…ˆåœ¨ Master ä¸Šçœ‹ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linux-node1 files]# salt <span class="s1">'*node2*'</span> pillar.items apache
linux-node2.example.com:
    <span class="nt">----------</span>
    apache:
        httpd
</code></pre></div></div>

<p>æ‰§è¡Œ state.highstate åçš„è¾“å‡ºå¦‚ä¸‹(æˆªå–éƒ¨åˆ†)ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">----------</span>
          ID: apache-config
    Function: file.managed
        Name: /etc/httpd/conf/httpd.conf
      Result: None
     Comment: The file /etc/httpd/conf/httpd.conf is <span class="nb">set </span>to be changed
     Started: 18:24:41.837882
    Duration: 107.177 ms
     Changes:   
              <span class="nt">----------</span>
              diff:
                  <span class="nt">---</span> 
                  +++ 
                  @@ <span class="nt">-39</span>,7 +39,9 @@
                   <span class="c"># prevent Apache from glomming onto all bound IP addresses.</span>
                   <span class="c">#</span>
                   <span class="c">#Listen 12.34.56.78:80</span>
                  <span class="nt">-Listen</span> 88
                  +Listen 192.168.56.12:88
                  +# The MAC is: 00:0c:29:bf:c0:16
                  +# Pillar <span class="nb">test</span>: User: salt Password: httpd    <span class="c"># æ­¤å¤„è¯´æ˜å·²ç»æˆåŠŸè®¾ç½®äº† pillar item</span>
                   
                   <span class="c">#</span>
                   <span class="c"># Dynamic Shared Object (DSO) Support</span>
<span class="nt">----------</span>
</code></pre></div></div>

<p>Pillar  ä¸Šé¢æ˜¯å†™åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­ï¼Œè¿˜æœ‰å¦å¤–ä¸€ç§æ–¹æ³•ï¼ŒGrains/Pillar ç­‰ä¹Ÿå¯ä»¥å†™åœ¨ SLS æ–‡ä»¶é‡Œé¢</p>

<h1 id="ref">Ref</h1>
<p><a href="http://docs.jinkan.org/docs/jinja2/index.html">Jinja2 æ–‡æ¡£</a><br />
<a href="http://www.linuxe.cn/post-247.html">SaltStacké…ç½®ç®¡ç†å·¥å…·jinja2æ¨¡æ¿çš„ä½¿ç”¨</a></p>
:ET